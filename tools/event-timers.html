<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <title>CME Tips</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"> <!-- get new -->
    <link href="/style.css" rel="stylesheet">

    <!-- special date stuff -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/2.4.0/luxon.min.js" integrity="sha512-v1zUTZ9zv9Wb2scL/ANxXM6m7yegm/W5SN8SRHNFADdZIuSFFkrEBjNxO803DdFkjoCcJ88g1WHRVlLN6K/O1A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>

  <body style="overflow-y: scroll">
    
    <div class="row row-main">
        <div class="col-md-1" id="sidebar-placeholder">

        </div>

        <div class="col-md-11">
            <div class="container-fluid fill">
                
                <div class="row text-start">
                    <div class="col-md-9 offset-md-1">
                        <div class="card shadow mb-4">
                            <div class="card-body">
                                <div class="jumbotron text-center">
                                    <h1 class="display-4 utc-clock"></h1>
                                    <p class="lead">Server Time (UTC + 1)</p>
                                  </div>

                                  <table class="table table-striped">
                                    <thead>
                                        <th scope="col">Server Time</th>
                                        <th scope="col">Your Time</th>
                                        <th scope="col">Events</th>
                                        <th scope="col">Occurs in...</th>
                                    </thead>
                                    <tbody id="table-body">
                                        
                                    </tbody>
                                  </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
  </body>

  <script>
    $(document).ready(function() {
        
        // Load shared sidebar
        $("#sidebar-placeholder").load("/sidebar.html", function() {
          
        });

        // Server time is UTC + 1
        updateTimers();
        setInterval(function(){
            updateTimers();
        }, 1000);

        function updateTimers() {
            let userTime = luxon.DateTime.local();
            let serverTime = userTime.toUTC(60);
            $(".utc-clock").text(serverTime.toFormat(timeFormat));
        }
    });
    </script>

    <script>
    const timeFormat = "HH:mm:ss";
    const shortFormat = "HH:mm";
    const jsonFormatTz = "HH:mmZ";
    const serverTimeOffset = 60;
    var timings;

    $(document).ready(function() {
        // Server time is UTC + 1
        updateTimers();
        setInterval(function(){
            updateTimers();
        }, 1000);
        
        $.getJSON("/tools/data/eventtimes.json", function(data) {
            timings = data.timings;
          /*
          [
            {
                "serverTime": "00:00",
                "events": [
                    "Daily reset"
                ]
            }
          ]
          */

          populateTimingTable();
      });
      
    });

    function updateTimers() {
        let serverTime = luxon.DateTime.local().toUTC(serverTimeOffset);
        $(".utc-clock").text(serverTime.toFormat(timeFormat));
    }

    function populateTimingTable(){
        let userTimeOffset = luxon.DateTime.local().offset;
        let serverDifference = serverTimeOffset - userTimeOffset;

        let html = "";
        timings.forEach(timing => {
            let row = "";
            let rowStart = "<tr>";
            let rowEnd = "</tr>";
            
            row += rowStart;

            let userTimezone = luxon.Settings.defaultZoneName;
            let userEventTime = luxon.DateTime
                .fromFormat(timing.serverTime + "+1", jsonFormatTz) // make sure the server +1 is accounted for
                .setZone(userTimezone);

            row += getTd(timing.serverTime);
            row += getTd(userEventTime.toFormat(shortFormat));
            row += getTd(getEvents(timing));
            row += getTd(getTimeUntil(userEventTime));

            row += rowEnd

            html += row;
        });

        $("#table-body").append(html);
    }

    function getTd(content){
        return "<td>" + content + "</td>"
    }

    function getEvents(timing) {
        let eventsHtml = "";
        timing.events.sort().forEach(event => {
            eventsHtml += "<p>" + event + "</p>";
        });

        return eventsHtml;
    }

    function getTimeUntil(localEventTime) {
        // Hopefully using the user time means it'll take DST shifts into account
        // nvm, those don't matter. too late, the code is local.
        let currentUserTime = luxon.DateTime.local();
        let until = localEventTime.diff(currentUserTime, ["hours", "minutes"]);

        // Negative means it's already happened today, so we need to check tomorrow.

        if (until.toMillis() < 0) {
            let eventTomorrow = localEventTime.plus(luxon.Duration.fromObject({
                days: 1
            }));
            until = eventTomorrow.diff(currentUserTime, ["hours", "minutes"]);
        }

        let friendlyText = "";

        if (until.hours > 0) {
            if (until.hours === 1) {
                friendlyText += "1 hour";
            }
            else {
                friendlyText += until.hours + " hours";
            }
        }

        if (until.minutes > 0) {
            if (friendlyText.length){
                friendlyText += ", ";
            }

            if (until.minutes === 1) {
                friendlyText += "1 minute";
            }
            else {
                friendlyText += Math.round(until.minutes) + " minutes";
            }
        }

        return friendlyText;
    }
    </script>

</html>