<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="og:title" content="CME Tips">
    <meta name="og:description" content="By the greatest player ever.">
    <meta name="og:image" content="https://marches0.github.io/img/banner.jpg">
    <meta name="twitter:card" content="summary_large_image" />
    <title>CME Tips</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"> <!-- get new -->
    <link href="/style.css" rel="stylesheet">

    <!-- extra chart fun -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js" integrity="sha256-ErZ09KkZnzjpqcane4SCyyHsKAXMvID9/xwbl/Aq1pc=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js" integrity="sha512-HrwQrg8S/xLPE6Qwe7XOghA/FOxX+tuVF4TxbvS73/zKJSs/b1gVl/P4MsdfTFWYFYg/ISVNYIINcg35Xvr6QQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  </head>

  <body style="overflow-y: scroll">
    
    <div class="row row-main">
        <div class="col-md-1" id="sidebar-placeholder">

        </div>

        <div class="col-md-11">
            <div class="container-fluid fill">
                
                <div class="row text-start">
                    <div class="col-md-9 offset-md-1">
                        <div class="card shadow mb-4">
                            <div class="card-body">
                              <h2>Season Points Calculator</h2>
                              <div class="mb-3">
                                  <div class="form-group">
                                      <label for="season-event">Event</label>
                                      <select class="form-control" id="season-event">
                                          <option selected disabled>Event</option>
                                      </select>
                                  </div>
                              </div>
                              <div id="event-parameters" style="display: none;">
                                  <div class="form-group">
                                      <label for="currency-used" id="season-currency-label"></label>
                                      <input type="number" class="form-control" id="currency-used">
                                    </div>
                                  <div class="form-group mt-3">
                                      <div class="row">
              
                                          <div class="col-md-4">
                                              <div class="card card-points">
                                                  <div class="card-body">
                                                  <h5>Last tier</h5>
                                                  <p id="last-tier-currency"></p>
                                                  <p id="last-tier-points" style="margin: 0px;"></p>
                                                  </div>
                                              </div>
                                          </div>
              
                                          <div class="col-md-4">
                                              <div class="card card-points shadow">
                                                  <div class="card-body">
                                                  <h5>Your points</h5>
                                                  <p id="your-points-currency"></p>
                                                  <p id="your-points-points" style="margin: 0px;"></p>
                                                  </div>
                                              </div>
                                          </div>
              
                                          <div class="col-md-4">
                                              <div class="card card-points">
                                                  <div class="card-body">
                                                  <h5>Next tier</h5>
                                                  <p id="next-tier-currency"></p>
                                                  <p id="next-tier-points" style="margin: 0px;"></p>
                                                  </div>
                                              </div>
                                          </div>
                                      </div>
                                  </div>
                              </div>
              
                              <canvas id="event-efficiency-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
  </body>

  <script>
    $(document).ready(function() {
        // Load shared sidebar
        $("#sidebar-placeholder").load("/sidebar.html", function() {
          
        });
    });
    </script>

    <script>
      var seasonEvents;
      var selectedEvent;
      var eventChart;

    $(document).ready(function() {      
      // Calculator stuff
      
      $.getJSON("/tools/data/seasonpoints.json", function(data) {
          seasonEvents = data.events;
          /*
          [
              {
                  "name": "Penglai",
                  "seasonCurrency": "Stamina",
                  "colour": "#ea9999",
                  "typical": 525,
                  "seasonPoints":[
                      [0, 0],
                      [45, 2000],
                      [currency, seasonPoints]
                  ]
              }
          ]
          */

          // Sort out the select list.
          let seasonEventList =  $("#season-event");
          seasonEvents.map(se => se.name).sort().forEach(eventName => {
              seasonEventList.append("<option>" + eventName + "</option>")
          });
      });
      
    });

    $("#season-event").on("change", function(e) {
      loadEvent(this.value);
      let currencyUsedInput = $("#currency-used");
      currencyUsedInput.val("");

      if(selectedEvent.typical) {
        currencyUsedInput.attr("placeholder", "Typical: " + selectedEvent.typical.toLocaleString());
      }
      else {
        currencyUsedInput.attr("placeholder", "");
      }
    });

    $("#currency-used").on("change", function(e) {
      processCurrencyUsed(Number(this.value));
    });

    function loadEvent(name){
      selectedEvent = seasonEvents.filter(s => s.name == name)[0];

      $("#season-currency-label").text(selectedEvent.seasonCurrency);
      $("#event-parameters").show();

      $(".card-points").css("border-color", hexToRGB(selectedEvent.colour, 0.75));

      // Set chart
      loadChart();

      // Reset tier entries
      setCurrencyText("last-tier-currency");
      setPointsText("last-tier-points");
      setCurrencyText("next-tier-currency");
      setPointsText("next-tier-points");
      setCurrencyText("your-points-currency");
      //$("#your-points-currency").text(""); // definitely duplcating code now
      $("#your-points-points").text("Total Season Points:");
    };

    function processCurrencyUsed(used) {
      setSeasonPointsEarnt(used);
      setLastTier(used);
      setNextTier(used);
    };

    function setSeasonPointsEarnt(used){
      let seasonPoints = selectedEvent.seasonPoints
          .filter(s => s[0] <= used)
          .reduce((total, tier) => total + tier[1], 0);

      setCurrencyText("your-points-currency", used);
      $("#your-points-points").text("Total Season Points: " + seasonPoints.toLocaleString());
    }

    function setLastTier(used) {
      let seasonTiersReached = selectedEvent.seasonPoints
          .filter(s => s[0] <= used)
          .sort(function(a, b){return a - b}); // I hate JS

      if (seasonTiersReached.length) {
        let lastTier = seasonTiersReached[seasonTiersReached.length - 1];
        setCurrencyText("last-tier-currency", lastTier[0]);
        setPointsText("last-tier-points", lastTier[1]);

        // Annotation seems to use x axis as nth entry,
        // rather than n along (e.g. annotate the 30th point, rather than
        // 30th stamina used), so drive it from the tier.
        // Also, it's off by one.
        setChartAnnotation(seasonTiersReached.length - 2, lastTier[0]);
      }
    };

    function setNextTier(used) {
      let seasonTiersMissed = selectedEvent.seasonPoints
          .filter(s => s[0] > used)
          .sort(function(a, b){return a - b}); // I hate JS

      if (seasonTiersMissed.length) {
        let firstTier = seasonTiersMissed[0];
        setCurrencyText("next-tier-currency", firstTier[0]);
        setPointsText("next-tier-points", firstTier[1]);
      }
      else {
        $("#next-tier-currency").text("Unknown");
        $("#next-tier-points").text("Unknown");
      }
    };

    function setCurrencyText(elementName, used) {
      if(used) {
        $("#" + elementName).text(selectedEvent.seasonCurrency + ": " + used.toLocaleString());
      }
      else{
        $("#" + elementName).text(selectedEvent.seasonCurrency + ":");
      }
    };

    function setPointsText(elementName, seasonPoints) {
      if(seasonPoints) {
        $("#" + elementName).text("Season Points: " + seasonPoints.toLocaleString());
      }
      else {
        $("#" + elementName).text("Season Points:");
      }
    };

    //https://stackoverflow.com/a/28056903
    function hexToRGB(hex, alpha) {
      var r = parseInt(hex.slice(1, 3), 16),
          g = parseInt(hex.slice(3, 5), 16),
          b = parseInt(hex.slice(5, 7), 16);

      if (alpha) {
          return "rgba(" + r + ", " + g + ", " + b + ", " + alpha + ")";
      } else {
          return "rgb(" + r + ", " + g + ", " + b + ")";
      }
    }

    function setChartAnnotation(tierNum, label){
      if(!eventChart) {
        return;
      }
      eventChart.options.plugins.annotation = {
        annotations: {
            lastTierLine: {
              type: 'line',
              xMin: tierNum,
              xMax: tierNum,
              borderColor: 'rgb(0, 0, 0, 0.25)',
              borderDash: [30, 15],
              borderWidth: 2,
              label: {
                content: "Last tier",
                backgroundColor:  'rgb(0, 0, 0, 0.25)',
                enabled: true
              }
            }
          }
      };
             
      eventChart.update();
    }

    function loadChart() {
      if(eventChart) {
        eventChart.destroy();
      }

      // y = efficiency @ currency
      // x = total currency
      let data = [];

      let totalScore = 0;
      selectedEvent.seasonPoints.forEach(tier => {
        // [0] = currency for this tier
        // [1] = season points for this tier
        if (tier[0] !== 0){
          totalScore += tier[1];

          data.push({
            x: tier[0],
            y: totalScore / tier[0]
          });
        }
      });

      let chartElement = document.getElementById('event-efficiency-chart').getContext('2d');
      chartElement.canvas.width = 100;
      chartElement.canvas.height = 50;

      eventChart = new Chart(chartElement,
      {
        type: "line",
        data: {
          labels: data.map(d => d.x.toLocaleString()),
          datasets: [{
            label: "Efficiency",
            data: data,
            fill: false,
            borderColor: hexToRGB(selectedEvent.colour),
            tension: 0.001
          }]
        },
        options: {
          scales: {
              x: {
                title:{
                  display: true,
                  text: selectedEvent.seasonCurrency
                },
                grid: {
                  display: false
                }
              },
              y: {
                title:{
                  display: true,
                  text: "Total Season Points per " + selectedEvent.seasonCurrency
                },
                grid: {
                  display: false
                }
              }
          }
       } 
      });
    }
    </script>

</html>